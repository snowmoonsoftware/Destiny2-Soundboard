<!DOCTYPE html>
<html>
    <head>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
         <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="https://unpkg.com/popper.js@1"></script>
        <script src="https://unpkg.com/tippy.js@5"></script>

        <script>
            $(document).ready(function(){
                $('.tabs').tabs();
                $('.modal').modal();

                $("#shaxx_search").on("input", async () => {
                    let inputId = "#shaxx_search";
                    let input = $(inputId).val();
                    search(inputId, input)
                })

                $("#saladin_search").on("input", async () => {
                    let inputId = "#saladin_search";
                    let input = $(inputId).val();
                    search(inputId, input)
                })

                $("#calus_search").on("input", async () => {
                    let inputId = "#calus_search";
                    let input = $(inputId).val();
                    search(inputId, input)
                })

                $("#cayde_search").on("input", async () => {
                    let inputId = "#cayde_search";
                    let input = $(inputId).val();
                    search(inputId, input)
                })

                $("#drifter_search").on("input", async () => {
                    let inputId = "#drifter_search";
                    let input = $(inputId).val();
                    search(inputId, input)
                })
                function inputChanged(inputId) {
                    return new Promise((resolve, reject) => {
                        let input = $(inputId).val();
                        setTimeout(() => {
                            if ($(inputId).val() !== input) reject();
                            else resolve();
                        }, 250);
                    })
                }

                async function search(inputId, input) {
                    try {
                        await inputChanged(inputId);
                        if (input === "") {
                            console.log("ok")
                            for (let i = 0; i < $(".sound-btn").length; i++) {
                                let btn = $(".sound-btn")[i];
                                btn.style.display = "";
                            }
                            return;
                        }
                        for (let i = 0; i < $(".sound-btn").length; i++) {
                            let btn = $(".sound-btn")[i];
                            if (!btn.innerText.toLowerCase().includes(input.toLowerCase())) btn.style.display = "none";
                        }
                    } catch (e) {
                        return;
                    }
                }
            });
        </script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <style>
            .bungie-green {
                color: #90A560 !important
            }
            .bungie-grey, body {
                background-color: #12171C !important
            }
            .bungie-yellow {
                color: #FFCE1F !important
            }
            .bungie-purple {
                color: #685272 !important
            }
            .content {
                color: #FFCE1F !important
            }

            .brand-logo {
                margin-left: 10px
            }

            .red.darken-3 {
                background-color: #000000 !important;
                border: 1px solid hsla(0,0%,100%,.5);
                border-width: .5px !important;
                border-radius: 0px !important;
            }

            .sound-btn {
                margin: 10px;
                border: 1px solid hsla(0,0%,100%,.5);
                width: 250px;
                height: 45px;
                justify-content: center;
            }

            @media only screen and (max-width: 600px) {
                .sound-btn {
                    margin: 10px;
                    width: 90vw
                }
            }

            .sound-tab {
                margin: 0 auto;
            }

            .white-text {
                color: #FAFAFA
            }
        </style>
    </head>
    <body>
        <nav>
            <div class="nav-wrapper bungie-grey">
                <a href="#" class="brand-logo">Destiny 2 Soundboard</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li><a href="#modal-disclaimer" class="modal-trigger">Disclaimer</a></li>
                </ul>
            </div>
        </nav>
        <div class="row">

            <div class="col s12">
              <ul class="tabs bungie-grey">
                <li class="tab col s2"><a href="#shaxx" class="active bungie-yellow waves-yellow">Shaxx</a></li>
                <li class="tab col s2"><a class="active bungie-green" href="#drifter">Drifter</a></li>
                <li class="tab col s2"><a class="active" href="#saladin">Saladin</a></li>
                <li class="tab col s2"><a class="active bungie-purple waves-purple" href="#calus">Calus</a></li>
                <li class="tab col s2"><a class="active bungie-yellow" href="#cayde">Cayde-6</a></li>
              </ul>
            </div>

            <div id="shaxx" class="col s12 sound_tab">
                <h4 class="bungie-yellow">Lord Shaxx</h4>
                <div class="input-field col s12">
                    <i class="material-icons prefix" style="color: white;">search</i>
                    <input id="shaxx_search" class="js-search" type="text" style="width: 75%; color: #FAFAFA">
                </div>                
                <h3 id="shaxx-loading" class="white-text">Loading...</h3>
            </div>

            <div id="saladin" class="col s12 bungie-yellow">
                <h3>Lord Saladin</h3>
                <div class="input-field col s12">
                    <i class="material-icons prefix" style="color: white;">search</i>
                    <input id="saladin_search" class="js-search" type="text" style="width: 75%; color: #FAFAFA">
                </div>                
                <h3 id="saladin-loading" class="white-text">Loading...</h3>
            </div>

            <div id="calus" class="col s12 bungie-yellow">
                <h3>Emperor Calus</h3>
                <div class="input-field col s12">
                    <i class="material-icons prefix" style="color: white;">search</i>
                    <input id="calus_search" class="js-search" type="text" style="width: 75%; color: #FAFAFA">
                </div>                
                <h3 id="calus-loading" class="white-text">Loading...</h3>
            </div>

            <div id="cayde" class="col s12 bungie-yellow">
                <h3>Cayde-6</h3>
                <div class="input-field col s12">
                    <i class="material-icons prefix" style="color: white;">search</i>
                    <input id="cayde_search" class="js-search" type="text" style="width: 75%; color: #FAFAFA">
                </div>                
                <h3 id="cayde-loading" class="white-text">Loading...</h3>
            </div>
            
            <div id="drifter" class="col s12 bungie-yellow">
                <h3>drifter</h3>
                <div class="input-field col s12">
                    <i class="material-icons prefix" style="color: white;">search</i>
                    <input id="drifter_search" class="js-search" type="text" style="width: 75%; color: #FAFAFA">
                </div>                
                <h3 id="drifter-loading" class="white-text">Loading...</h3>
            </div>
            
          </div>

          <div id="modal-disclaimer" class="modal">
            <div class="modal-content">
                <h4>Disclaimer</h4>
                <p>I do not own any rights to the sound files used in this repository. All sound content in this project is owned by Bungie, Inc. and their respective owners.</p>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
            </div>
        </div>
    </body>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        const dev = true;
        const githubApiUrl = 'https://api.github.com/repos/snowmoonsoftware/Destiny2-Soundboard/contents';
        const destinyDictionaryBlob = 'https://api.github.com/repos/snowmoonsoftware/Destiny2-Soundboard/git/blobs/94d4ca3cef7056a374d938608fe2a5ca0afafe7d';
        const githubRawUrl = 'https://raw.githubusercontent.com/snowmoonsoftware/Destiny2-Soundboard/master';
        var dict = null;

        async function get(url) {
            return new Promise((resolve, reject) => {
                let xhr = new XMLHttpRequest();
                function reqListener() {
                    return resolve(this.responseText);
                }
                xhr.addEventListener("load", reqListener);
                xhr.open("GET", url, true);
                xhr.send();
            });
        }
        async function getDictionary() {
            dict = (dev ? JSON.parse(await get("/dict.json")) : JSON.parse(atob(JSON.parse(await get(destinyDictionaryBlob)).content)));
        }

        async function getLines(who) {
            var data =  dev ? JSON.parse(await get(who)) : JSON.parse(atob(JSON.parse(await get(githubApiUrl + who)).content));

            return data.lines;
        }


        async function buildVendorSoundboard(vendor, skipDictionary) {
            const parentElement = document.getElementById(vendor);
            const url = `/${vendor}.json`;
            const lines = dev ? JSON.parse(await get(url)).lines : JSON.parse(atob(JSON.parse(await get(githubApiUrl + url)).content)).lines;
            const lines_keys = Object.keys(lines);
            // const dict = !dev
            // ? JSON.parse(atob(JSON.parse(await get(destinyDictionaryBlob)).content))
            // : JSON.parse(await get("/dict.json"));
            const dict = getDictionary();


            for (let i = 0; i < lines_keys.length; i++) {
                const title = lines_keys[i]; // Title of h3 element
                const keys = Object.keys(lines[title]);
                const vals = Object.values(lines[title]);
                let h3 = document.createElement("h3"); // Create h3 element
                h3.classList.add("white-text"); // Make text white
                let th3 = document.createTextNode(title); // Add title to h3
                h3.appendChild(th3);
                parentElement.appendChild(h3);

                for (let x = 0; x < keys.length; x++) {
                    const bungieHex = keys[x];
                    var value = (dict[bungieHex] === undefined) ? vals[x] : dict[bungieHex];
                    let elm = document.createElement("a");
                    elm.classList.add("waves-effect", "waves-light", "btn", "sound-btn", "red", "darken-3");
                    elm.setAttribute('data-hex', bungieHex);
                    elm.title = (dict[bungieHex] === undefined) ? vals[x] : dict[bungieHex];
                    elm.setAttribute('data-tippy-content', value);
                    let t = document.createTextNode( value);
                    elm.appendChild(t);

                    elm.onclick = function() {
                        const audio = new Audio(!dev ? `${githubRawUrl}/ogg/${vendor}/${bungieHex}.mp3` : `/ogg/${vendor}/${bungieHex}.mp3`);
                        audio.play(); 
                    };
                    parentElement.appendChild(elm);
                }
            }
        }

        //shaxx();
        buildVendorSoundboard("shaxx", true);
        buildVendorSoundboard("calus", false);
        buildVendorSoundboard("saladin", false);
        buildVendorSoundboard("cayde", false);
        buildVendorSoundboard("drifter", false);
    </script>
</html>
